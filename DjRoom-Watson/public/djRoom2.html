<!DOCTYPE html>
<html>

<head>
	<title>DJ Room UI</title>
	<meta charset="UTF-8" />
	<!-- bootstrap  -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	 crossorigin="anonymous">
	<!-- css -->
	<link rel="stylesheet" href="css/main.css">
	<style type="text/css" media="screen">

	</style>
</head>

<body>
	<!-- Big player on the top -->
	<H1>This is DJ page</H1>
	<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
	<div id="player"></div>

	<form action="">
		<input id="inbox" autocomplete="off" /><button>Send</button>
	</form>



	<!-- <div id="info"></div>
		<div id="fire"></div>
		<div id="info2"></div> -->
	<!-- Room info: telling users audience number and who is taking control -->
	<div id="room-info container-fluid">
		<p class="grid-row col-xs-4 bg-one" id="eyeIcon">&#128065;</p>
		<p class="grid-row col-xs-8 bg-two">You are taking control</p>
	</div>
	<!-- UI of searching and adding songs -->
	<div id="controler container-fluid">
		<div id="playlist-container" class="grid-row col-lg-4 col-md-4 col-sm-4 col-xs-12 bg-two">
			<h5>Next Song: </h5>
			<ul id="playlist">

			</ul>
		</div>
		<div id="search-container" class="grid-row col-lg-8 col-md-8 col-sm-8 col-xs-12 bg-one">
			<form id=search-box>
				<input id="searchKeyword" autocomplete="off" placeholder="search" /> <button id="goSearch">&#x1F50D;</button>
			</form>
			<ul id=search-result>
			</ul>
		</div>
	</div>
	<!-- end of div controler -->
	<!-- script -->
	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="main.js"></script>
	<script src="https://apis.google.com/js/client.js?onload=init"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
	<!-- kevin: youtube loader -->
	<script>
		// 2. This code loads the IFrame Player API code asynchronously.
		var tag = document.createElement('script');

		tag.src = "https://www.youtube.com/iframe_api";
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		// 3. This function creates an <iframe> (and YouTube player)
		//    after the API code downloads.
		var player;
		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: '390',
				width: '640',
				videoId: 'T4SimnaiktU',
				events: {
					'onReady': onPlayerReady,
					'onStateChange': onPlayerStateChange
				}
            });
            
		}
		//https://www.youtube.com/embed/1QUsmcZtlTE?start=88

		// 4. The API will call this function when the video player is ready.
		function onPlayerReady(event) {
			event.target.playVideo();
		}

		// 5. The API calls this function when the player's state changes.
		//    The function indicates that when playing a video (state=1),
		//    the player should play for six seconds and then stop.
		var done = false;
		function onPlayerStateChange(event) {
			if (event.data == YT.PlayerState.PLAYING && !done) {
				//setTimeout(stopVideo, 6000);
				done = true;
			}
		}
		function stopVideo() {
			player.stopVideo();
		}
	</script>
	<!-- kevin: socket io for DJ sync -->
	<script>
			var socket = io();

			//take the message from from when submit are click
			$('form').on('click', () => {
				if ($('#inbox').val() !== '') {

					socket.emit('chat message', $('#inbox').val())
					//empty the box after send
					$('#inbox').val('');
					return false;
				}
			})

			socket.on('chat message', (msg) => {
				if (msg === 'REQUEST_NOW') {
					socket.emit('chat message', `B${player.getCurrentTime()}D${Date.now()}NEW`)
					fire_client();
				} else if (msg === 'REREQUEST') {
					console.log('DJ-restarting')
					socket.emit('chat message', `B${player.getCurrentTime()}D${Date.now()}`)
					fire_client();
				}
			})

			function fire_client() {

				var stop_si = setInterval(() => {
					$('#fire').html(`<h3 style="color: white">Fire Time ${player.getCurrentTime()} </p></h3>`)
					socket.emit('FIRE', `${player.getCurrentTime()}D${Date.now()}`)

				}, 150)
				setTimeout(() => { clearInterval(stop_si) }, 3500)
			}



			setInterval(() => {
				$('#info').html(`<h3 style="color: white">currentTime ${player.getCurrentTime()} </p></h3>`)
				socket.emit('CHECKING', player.getCurrentTime())
			}, 1000)

			//dj stop, client stop also
			function onPlayerStateChange(e) {
				console.log(e)
				if (e.data === 1) {
					socket.emit('chat message', `B${player.getCurrentTime()}D${Date.now()}`)
					fire_client()
				}
				if (e.data === 2) {
					socket.emit('chat message', 'STOP')
				}
			}
	</script>

</body>

</html>